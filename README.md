# bbb-cutter utility pack

This utility pack has two small utilities to manage the videos recorded by BigBlueButton web conferencing system (see https://bigbluebutton.org/ ).
It consists `bbb-cutter` and `bbb-listgen` utilities.

- `bbb-listgen` utility will generate list of videos in HTML format based on the specified directory with BigBlueButton tree structure
- `bbb-cutter` utility will perform video cutting based on CSV file and specified directory paths with BigBlueButton tree structure

Clone this repository to the working directory, install necessary dependencies and run.

## Dependencies

It required Python 3.x+ to be installed on the system.

This utility pack has the following dependencies:
- ffmpeg-python
- jQuery, Bootstrap 4.5.2, Popper.js, DataTables for generated HTML by bbb-listgen (will be downloaded automatically from CDN).

## Installation

```
git clone https://github.com/keyno/bbb-cutter.git
pip3 install ffmpeg-python
cd bbb-cutter
```

## bbb-listgen usage

Usage:
```
python3 bbb-listgen.py <video_dir> <html_file>
```

This tool will generate HTML file with the table of videos from the directory specified by command-line parameter `<video_dir>`.
The list will consist MeetingID, Record name, Preview image (thumbnail), Datetime, Duration, Maximum participants and Compressed size.

Note: Source video stored in `<video_dir>` must satisfy the format of BigBlueButton directory structure with the file `metadata.xml`.

Example:
```
python3 bbb-listgen.py /var/bigbluebutton/published/presentation list.html
```
The script will generate file named `list.html` with the list of videos based on directory content located in `/var/bigbluebutton/published/presentation` path.

## bbb-cutter usage

Usage:
```
python3 bbb-cutter.py <src_video_dir> <dst_video_dir> <csv_file>
```

This tool will cut the videos from `src_video_dir` based on the rules described in `csv_file`, re-render it and will save in `dst_video_dir` with the same directory structure with updated metadata.

File `csv_file` must consist comma-separated values with the header. Header must contain the following data:
- `event_id` - just some internal id for further processing of the data
- `hall` - hall name where the presentation take place. Used in generation the name string of new video
- `subject` - subject of the presentation on the video
- `firstname` - first name of the speaker of the presentation. Could have `NULL` value
- `lastname` - last name of the speaker of the presentation. Could have `NULL` value
- `author` - value that will be taken if firstname or last name has `NULL` value
- `meeting_id` - internal id of BigBlueButton record. Could be received from `list-gen.py` HTML list or by observing `/var/bigbluebutton` directory
- `offset_start` - offset from the start of the video provided by `meeting_id` in MM:SS format. Specifies the start of the new video. For example: `7:06` means that the tool will cut the video from 7th minute and 6th second
- `offset_end` - offset from the start of the video provided by `meeting_id` in MM:SS format. Specifies the end of the new video. For example: `10:53` means that the tool will cut the video by 10th minute and 53th second.

Note: Field names `hall`, `subject`, `firstname`, `lastname`, `author` used only in generation of the name string of the new video but still required to specify.

Next after header the respective content should be provided as well separated by semicolon.

Field order doesn't matters.

Example of `csv_file` content:
```
event_id;hall;author;subject;firstname;lastname;meeting_id;offset_start;offset_end
1;Caucasus;Dmitry Nershin;Session Introduction;NULL;NULL;3626bab7afcafe17836f4bffbb7e12f589fe1709-1600072269428;7:05;10:53
2;Kamchatka;NULL;Some patterns of landcape planning across Poland;Urszula;Komorowska;3626bab7afcafe17836f4bffbb7e12f589fe1709-1600072269428;10:53;33:22
3;Siberia;NULL;Landscape features impact to the runoff;Alexey;Fositskiy;3626bab7afcafe17836f4bffbb7e12f589fe1709-1600072269428;96:05;114:50
4;Baikal;Maria Mironova;Digital mapping of topsoil water;NULL;NULL;3626bab7afcafe17836f4bffbb7e12f589fe1709-1600072269428;33:22;49:35
```

The example above will produce four videos and move it in `dst_video_dir` based on the specific rules.

The file `report.txt` will be also created in the `dst_video_dir`. It has the following information separated by tabs:
- `event_id` - just copied event_id from `csv_file`
- `playback_id` - new meeting_id generated by internal rules of the tool
- `date_start` - new timestamp in milliseconds that stores the real date/time of the recorded video
- `duration` - new duration of the video in seconds

Example:
```
python3 bbb-cutter.py /var/bigbluebutton/published/presentation/ /home/pavel/cutted videos.csv
```

The example above will process the file `videos.csv` and will seek for specified IDs in `/var/bigbluebutton/published/presentation/` and will store the result in `/home/pavel/cutted`. All inexistend directories will be created automatically.

## Known bugs

Well, described utilities don't have a proper error handling for now, so, we don't have any warranties if it will be unstable in case of some files will be absent in working directories.
So, it's very important to follow the directory structure of BigBlueButton video and keep in order the all necessary metadata.

## Authors

Written by Pavel Keyno and Alexander Novikov
